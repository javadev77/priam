<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd
		http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">


    <!-- job de service import Programme -->

    <job id="jobServiceImport" xmlns="http://www.springframework.org/schema/batch">

        <step id="readFromCsvFile" next="insertData">
            <tasklet>
                <chunk
                        reader="readFromCsv"
                        processor="processor"
                        writer="writerPriam"
                        commit-interval="100"
                        retry-limit="10">
                    <retryable-exception-classes>
                        <include class="org.springframework.dao.DeadlockLoserDataAccessException"/>
                        <include class="org.springframework.dao.CannotAcquireLockException"/>
                    </retryable-exception-classes>
                </chunk>
            </tasklet>
        </step>

        <step id="insertData">
            <tasklet>
                <chunk
                    reader="readFromTableDataBatch"
                    processor="processData"
                    writer="writerFinal"
                    commit-interval="100"
                    retry-limit="10">
                    <retryable-exception-classes>
                        <include class="org.springframework.dao.DeadlockLoserDataAccessException"/>
                        <include class="org.springframework.dao.CannotAcquireLockException"/>
                    </retryable-exception-classes>
                </chunk>
            </tasklet>
        </step>

        <listeners merge="true">
            <listener ref="listenerCompletionImport"/>
        </listeners>

    </job>

    <bean id="readFromTableDataBatch" class="org.springframework.batch.item.database.JdbcPagingItemReader" scope="step">
        <property name="dataSource" ref="dataSource"/>
        <property name="queryProvider" ref="qpDataBatch"/>
        <property name="pageSize" value="100"/>
        <property name="rowMapper" ref="rowMapper"/>
    </bean>


    <bean id="qpDataBatch" class="org.springframework.batch.item.database.support.SqlPagingQueryProviderFactoryBean" scope="step">
        <property name="databaseType" value="MySQL" />
        <property name="selectClause" value="select l.*"/>
        <property name="fromClause" value="FROM PRIAM_IMPORT_PROGRAMME_FV_DATA_BATCH l
                                            INNER JOIN PRIAM_FICHIER f ON l.ID_FICHIER=f.ID
                                            INNER JOIN PRIAM_PROGRAMME p ON p.NUMPROG=f.NUMPROG"/>
        <property name="whereClause" value="WHERE p.NUMPROG='#{jobParameters[numProg]}'
                                              GROUP BY l.id
                                               "/>

        <property name="dataSource" ref="dataSource"/>
        <property name="sortKey" value="l.ide12"/>
    </bean>

    <bean id="rowMapper" class="fr.sacem.priam.batch.fv.serviceimport.mapper.ImportDataRowMapper"/>

    <bean id="processor" class="fr.sacem.priam.batch.fv.serviceimport.processor.ImportFvItemProcessor"/>

    <bean id="processData" class="fr.sacem.priam.batch.fv.serviceimport.processor.ImportDataProcessor"/>

    <bean id="readFromCsv" class="fr.sacem.priam.batch.fv.serviceimport.reader.ImportCsvFileItemReader" scope="step">
        <property name="lineMapper">
            <bean class="fr.sacem.priam.batch.fv.serviceimport.reader.ImportFVLineMapper">
                <property name="lineTokenizer">
                    <bean class="org.springframework.batch.item.file.transform.DelimitedLineTokenizer">
                        <property name="names"
                            value="cdeFamilTypUtil,cdeTypUtil,numProg,rionEffet,ide12,cdeTypIde12,ide12RepCoad,cdeTypIde12RepCoad,datsitu,datconslt,
                                    coad,numPers,numCatal,idSteAd,rolAd,typeDroit,cleAd,cdeTypProtect,coadOriEdtr,idSteOriEdtr,points,
                                    nomProgramme,tax,durDif,nbrDif,typMt,mt,genreOeuvre,titreOeuvre,dureeDeposee,taxOri,
                                    labelValo,paysOri,indicRepart,nom,prenom,indicSacem,sousRole,anneeNaissance,anneeDeces,indicDrtPercus"/>

                        <property name="delimiter" value=";"/>
                    </bean>
                </property>
                <property name="fieldSetMapper">
                    <bean class="org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper">
                        <property name="targetType" value="fr.sacem.priam.batch.fv.export.domain.ExportCsvDto"/>
                        <property name="customEditors">
                            <map>
                                <entry key="java.time.LocalDate">
                                    <bean class="fr.sacem.priam.batch.common.util.LocalDatePropertyEditor">
                                    </bean>
                                </entry>

                                <entry key="java.lang.Double">
                                    <bean class="fr.sacem.priam.batch.common.util.DoublePropertyEditor">
                                    </bean>
                                </entry>
                            </map>
                        </property>
                    </bean>
                </property>
            </bean>
        </property>
    </bean>

    <bean id="writerPriam" class="org.springframework.batch.item.database.JdbcBatchItemWriter" scope="step">
        <property name="dataSource" ref="dataSource"/>
        <property name="sql">
            <value>
                <![CDATA[
                    INSERT INTO PRIAM_IMPORT_PROGRAMME_FV_DATA_BATCH (
                            ID_FICHIER,
                            cdeFamilTypUtil,cdeTypUtil,numProg,rionEffet,ide12,cdeTypIde12,ide12RepCoad,cdeTypIde12RepCoad,datsitu,datconslt,
                            coad,numPers,numCatal,idSteAd,rolAd,typeDroit,cleAd,cdeTypProtec,coadOriEdtr,idSteOriEdtr,points,
                            NOM_PRG,tax,durDif,nbrDif,typMt,mt,genreOeuvre,titreOeuvre,dureeDeposee,taxOri,
                            labelValo,paysOri,indicRepart,nom,prenom,indicSacem,SOUS_ROLE,ANNEE_NAISSANCE,ANNEE_DECES,indicDrtPercus

                        )
                        VALUES (
                            :idFichier,
                            :cdeFamilTypUtil,
                            :cdeTypUtil,
                            :numProg,
                            :rionEffet,
                            :ide12,
                            :cdeTypIde12,
                            :ide12RepCoad,
                            :cdeTypIde12RepCoad,
                            :datsitu,
                            :datconslt,
                            :coad,
                            :numPers,
                            :numCatal,
                            :idSteAd,
                            :rolAd,
                            :typeDroit,
                            :cleAd,
                            :cdeTypProtect,
                            :coadOriEdtr,
                            :idSteOriEdtr,
                            :points,
                            :nomProgramme,
                            :tax,
                            :durDif,
                            :nbrDif,
                            :typMt,
                            :mt,
                            :genreOeuvre,
                            :titreOeuvre,
                            :dureeDeposee,
                            :taxOri,
                            :labelValo,
                            :paysOri,
                            :indicRepart,
                            :nom,
                            :prenom,
                            :indicSacem,
                            :sousRole,
                            :anneeNaissance,
                            :anneeDeces,
                            :indicDrtPercus
                        )
                ]]>
            </value>
        </property>
        <property name="itemSqlParameterSourceProvider">
            <bean class="org.springframework.batch.item.database.BeanPropertyItemSqlParameterSourceProvider"/>
        </property>
    </bean>

    <bean id="writerFinal" class="org.springframework.batch.item.database.JdbcBatchItemWriter" scope="step">
        <property name="dataSource" ref="dataSource"/>
        <property name="sql">
            <value>
                <![CDATA[
                    INSERT INTO PRIAM_IMPORT_PROGRAMME_FV_DATA_BATCH (
                            ID_FICHIER,
                            cdeFamilTypUtil,cdeTypUtil,numProg,rionEffet,ide12,cdeTypIde12,ide12RepCoad,cdeTypIde12RepCoad,datsitu,datconslt,
                            coad,numPers,numCatal,idSteAd,rolAd,typeDroit,cleAd,cdeTypProtec,coadOriEdtr,idSteOriEdtr,points,
                            NOM_PRG,tax,durDif,nbrDif,typMt,mt,genreOeuvre,titreOeuvre,dureeDeposee,taxOri,
                            labelValo,paysOri,indicRepart,nom,prenom,indicSacem,SOUS_ROLE,ANNEE_NAISSANCE,ANNEE_DECES,indicDrtPercus

                        )
                        VALUES (
                            :idFichier,
                            :cdeFamilTypUtil,
                            :cdeTypUtil,
                            :numProg,
                            :rionEffet,
                            :ide12,
                            :cdeTypIde12,
                            :ide12RepCoad,
                            :cdeTypIde12RepCoad,
                            :datsitu,
                            :datconslt,
                            :coad,
                            :numPers,
                            :numCatal,
                            :idSteAd,
                            :rolAd,
                            :typeDroit,
                            :cleAd,
                            :cdeTypProtect,
                            :coadOriEdtr,
                            :idSteOriEdtr,
                            :points,
                            :nomProgramme,
                            :tax,
                            :durDif,
                            :nbrDif,
                            :typMt,
                            :mt,
                            :genreOeuvre,
                            :titreOeuvre,
                            :dureeDeposee,
                            :taxOri,
                            :labelValo,
                            :paysOri,
                            :indicRepart,
                            :nom,
                            :prenom,
                            :indicSacem,
                            :sousRole,
                            :anneeNaissance,
                            :anneeDeces,
                            :indicDrtPercus
                        )
                ]]>
            </value>
        </property>
        <property name="itemSqlParameterSourceProvider">
            <bean class="org.springframework.batch.item.database.BeanPropertyItemSqlParameterSourceProvider"/>
        </property>
    </bean>


    <bean id="listenerCompletionImport" class="fr.sacem.priam.batch.fv.serviceimport.listener.JobImportFVListener"/>


</beans>
