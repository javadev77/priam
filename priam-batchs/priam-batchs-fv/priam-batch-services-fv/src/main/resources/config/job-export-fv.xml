<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd
		http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">

    <job id="jobExportFV" xmlns="http://www.springframework.org/schema/batch">

        <step id="stepGenerateCsv">
            <tasklet>
                <chunk
                        reader="exportCsvReader"
                        writer="csvExportFileWriter"
                        commit-interval="${commit-interval}"
                        >
                </chunk>
            </tasklet>
        </step>

        <listeners merge="true">
            <listener ref="listenerCompletion"/>
        </listeners>
    </job>

    <bean id="listenerCompletion" class="fr.sacem.priam.batch.fv.export.listener.JobExportFVListener"/>

    <bean id="exportCsvReader"
          class="org.springframework.batch.item.database.JdbcPagingItemReader" scope="step">
        <property name="dataSource" ref="dataSource"/>
        <property name="queryProvider" ref="queryExportCsvReader"/>
        <property name="pageSize" value="${commit-interval}"/>
        <property name="rowMapper" ref="exportCsvMapper"/>

    </bean>

    <bean id="queryExportCsvReader" class="org.springframework.batch.item.database.support.SqlPagingQueryProviderFactoryBean" scope="step">
        <property name="databaseType" value="MySQL" />
        <property name="selectClause" value="SELECT FV.cdeFamilTypUtil, FV.cdeTypUtil, FV.numProg, FV.rionEffet, FV.ide12, FV.cdeTypIde12, PAD.IDE12REPCOAD, PAD.CDETYPIDE12REPCOAD, PAD.COAD,
        PAD.NUMPERS, PAD.NUMCATAL, PAD.IDSTEAD, PAD.ROLAD, PAD.CLEAD, PAD.CDETYPPROTEC, PAD.COADORIEDTR, PAD.IDSTEORIEDTR, FV.tax, FV.durDif, FV.nbrDif,
        FV.typMt, FV.mt, FV.genreOeuvre, FV.titreOeuvre, FV.dureeDeposee, FV.taxOri, FV.paysOri, FV.indicRepart, PP.NOM, PERS.NOM, PERS.PRENOM, PERS.INDICSACEM,
        PERS.SOUS_ROLE, PERS.ANNEE_NAISSANCE, PERS.ANNEE_DECES, PERS.INDICDRTPERCUS "/>
        <property name="fromClause" value="PRIAM_LIGNE_PROGRAMME_FV FV
        INNER JOIN PRIAM_FICHIER PF on FV.ID_FICHIER = PF.ID
        INNER JOIN PRIAM_PROGRAMME PP on PP.NUMPROG = PF.NUMPROG
        INNER JOIN PRIAM_AYANT_DROIT PAD on FV.id = PAD.ID_FV
        INNER JOIN PRIAM_AYANT_DROIT_PERS PERS on PAD.NUMPERS = PERS.NUMPERS"/>
        <property name="whereClause" value="WHERE PP.NUMPROG ='#{jobParameters[numProg]}' AND FV.isOeuvreComplex = 0"/>

        <property name="dataSource" ref="dataSource"/>
        <property name="sortKey" value="PAD.COAD"/>
    </bean>

    <bean id="exportCsvMapper" class="fr.sacem.priam.batch.fv.export.mapper.ExportCsvMapper"/>

</beans>
